// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Recomendado para SaaS. Mude para sqlite se for apenas dev local.
}

// --------------------------------------
// ENUMS
// --------------------------------------

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELED
  COMPLETED
}

enum CalendarProvider {
  GOOGLE
  APPLE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

enum PaymentInterval {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum PaymentStatus {
  PENDING
  APPROVED
  REFUNDED
  PARTIALLY_REFUNDED
  FAILED
}

enum PaymentType {
  APPOINTMENT // Cliente pagando agendamento
  SUBSCRIPTION // Cliente pagando plano do salão
  SAAS_FEE // Salão pagando a plataforma (SaaS)
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
}

enum UserRole {
  ADMIN
  TENANT
  CUSTOMER
}

// --------------------------------------
// MODELS
// --------------------------------------

// 1. Tabela de Planos do SEU SaaS (Normalização)
// Isso evita repetir o preço "99.00" em cada linha de Tenant
model SaasPlan {
  id          String          @id @default(uuid())
  name        String // Ex: "Basic", "Pro"
  price       Decimal         @db.Decimal(10, 2)
  description String?
  interval    PaymentInterval @default(MONTHLY)

  tenants Tenant[] // Quem assina este plano?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("saas_plans") // Nome da tabela no Postgres
}

// 1b. Tabela de Usuários para Autenticação
model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String   // bcrypt hashed
  role     UserRole @default(TENANT)

  // Optional links to existing entities
  tenantId String? @unique @map("tenant_id")
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  customerId String?   @unique @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id])

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Tenant {
  id   String @id @default(uuid())
  name String

  // WhatsApp Info (Metadados da API)
  wabaId      String? @unique @map("waba_id")
  phoneId     String? @unique @map("phone_id")
  accessToken String? @map("access_token") // Token Meta

  // Contato
  phone String
  email String @unique

  // Integração Mercado Pago (Credentials)
  mpAccessToken String? @map("mp_access_token")
  mpPublicKey   String? @map("mp_public_key")
  mpRefToken    String? @map("mp_ref_token")

  // Gestão da Assinatura do SaaS (Relacionamento com SaasPlan)
  saasStatus          SubscriptionStatus @default(ACTIVE) @map("saas_status")
  saasNextBilling     DateTime?          @map("saas_next_billing")
  saasPaymentMethodId String?            @map("saas_payment_method_id")

  saasPlanId String   @map("saas_plan_id")
  saasPlan   SaasPlan @relation(fields: [saasPlanId], references: [id])

  // Relacionamentos do Negócio
  // Agora aponta para a tabela de vínculo
  customerLinks  TenantCustomer[]
  calendar       Calendar?
  services       Service[]
  appointments   Appointment[]
  plans          Plan[]
  operatingHours OperatingHour[]
  payments       Payment[]

  // User authentication link
  user User?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tenants")
}

model OperatingHour {
  id  String    @id @default(uuid())
  day DayOfWeek

  startTime String @map("start_time") // "HH:mm"
  endTime   String @map("end_time") // "HH:mm"

  isClosed           Boolean @default(false) @map("is_closed")
  onlyForSubscribers Boolean @default(false) @map("only_for_subscribers")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Index para performance nas queries de disponibilidade
  @@index([tenantId, day])
  @@map("operating_hours")
}

model Calendar {
  id       String           @id @default(uuid())
  provider CalendarProvider
  email    String

  accessToken  String    @map("access_token")
  refreshToken String    @map("refresh_token")
  tokenExpiry  DateTime? @map("token_expiry")

  tenantId String @unique @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("calendars")
}

model Service {
  id       String  @id @default(uuid())
  name     String
  price    Decimal @db.Decimal(10, 2)
  duration Int // Minutos

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  appointments Appointment[]

  // Relacionamento N:N implícito com Plan
  plans Plan[]

  @@map("services")
}

model Plan {
  id              String          @id @default(uuid())
  name            String
  description     String?
  price           Decimal         @db.Decimal(10, 2)
  interval        PaymentInterval @default(MONTHLY)
  maxAppointments Int             @default(-1) @map("max_appointments")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  subscriptions Subscription[]
  services      Service[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("plans")
}

// ESTA É A TABELA DE VÍNCULO (N:N Explícito)
model TenantCustomer {
  id String @id @default(uuid())

  // Configurações específicas deste cliente NESTE salão
  offerNotification Boolean @default(true) @map("offer_notification")
  mpCustomerId      String? @map("mp_customer_id") // ID do cliente na conta MP do dono do salão

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  customerId String   @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // A assinatura é vinculada ao relacionamento Salão <-> Cliente
  subscription Subscription?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, customerId]) // Garante que não haja duplicidade de vínculo
  @@map("tenant_customers")
}

model Customer {
  id    String  @id @default(uuid())
  phone String
  name  String?
  email String?

  // Um cliente pode estar em vários salões
  tenantLinks TenantCustomer[]

  appointments Appointment[]
  payments     Payment[]

  // User authentication link
  user User?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([phone])
  @@map("customers")
}

model Subscription {
  id          String             @id @default(uuid())
  status      SubscriptionStatus @default(ACTIVE)
  startDate   DateTime           @default(now()) @map("start_date")
  nextBilling DateTime           @map("next_billing")

  cardTokenId String @map("card_token_id")
  externalId  String? @unique @map("external_id")

  planId String @map("plan_id")
  plan   Plan   @relation(fields: [planId], references: [id])

  // Agora a assinatura pertence ao Vínculo Salão-Cliente
  tenantCustomerId String         @unique @map("tenant_customer_id")
  tenantCustomer   TenantCustomer @relation(fields: [tenantCustomerId], references: [id])

  appointments Appointment[]
  payments     Payment[] // Faturas

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@map("subscriptions")
}

model Appointment {
  id     String            @id @default(uuid())
  date   DateTime
  status AppointmentStatus @default(PENDING)

  cancellationReason String?   @map("cancellation_reason")
  canceledAt         DateTime? @map("canceled_at")

  // Snapshot do preço (Importante para histórico financeiro)
  price Decimal @db.Decimal(10, 2)

  paymentId String?  @unique @map("payment_id")
  payment   Payment? @relation(fields: [paymentId], references: [id])

  externalEventId String? @map("external_event_id")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  customerId String   @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id])

  serviceId String?  @map("service_id")
  service   Service? @relation(fields: [serviceId], references: [id])

  usedSubscriptionId String?       @map("used_subscription_id")
  usedSubscription   Subscription? @relation(fields: [usedSubscriptionId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("appointments")
}

model Payment {
  id         String  @id @default(uuid())
  externalId String? @unique @map("external_id") // ID do MP

  amount    Decimal  @db.Decimal(10, 2)
  netAmount Decimal? @map("net_amount") @db.Decimal(10, 2)
  fee       Decimal? @db.Decimal(10, 2)

  status PaymentStatus @default(PENDING)
  type   PaymentType
  method PaymentMethod

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  customerId String?   @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id])

  appointment Appointment?

  subscriptionId String?       @map("subscription_id")
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payments")
}
